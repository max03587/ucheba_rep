import sys,ctypes
from PySide6.QtWidgets import QApplication, QLabel, QGraphicsPixmapItem,QGraphicsItem , QGraphicsScene, QGraphicsView, QGraphicsRectItem, QMainWindow, QWidget, QVBoxLayout
from PySide6.QtGui import QBrush, QColor, QPixmap,QIcon
from PySide6.QtCore import QSize


class Main_window(QMainWindow):
    def __init__(self, scene):
        super().__init__()
        self.setWindowTitle("Шахматы")
        self.setFixedSize(QSize(680, 680))
        self.setCentralWidget(central_widget)
        self.scene = scene


app = QApplication(sys.argv)
central_widget = QWidget()
layout = QVBoxLayout()
central_widget.setLayout(layout)


scene = QGraphicsScene()


class fig_item(QGraphicsPixmapItem):
    def __init__(self, image, position, width, height,board_positions):
        super().__init__()
        pixmap = QPixmap(image).scaled(width, height)
        if pixmap.isNull():
            print(f"Не удалось загрузить изображение {image}")
        self.setPixmap(pixmap)
        self.setPos(*position)
        self.setFlag(QGraphicsItem.ItemIsMovable, True)
        self.setFlag(QGraphicsItem.ItemIsSelectable, True)
        self._start_pos = None
        self.board_positions = board_positions
        

    def mousePressEvent(self, event):
        self._start_pos = event.scenePos()
        super().mousePressEvent(event)

    def mouseMoveEvent(self, event):
        if self._start_pos is not None:
            new_pos = event.scenePos()
            delta = new_pos - self._start_pos
            self.setPos(self.pos() + delta)
            self._start_pos = new_pos
        super().mouseMoveEvent(event)

    def mouseReleaseEvent(self, event):
        closest_pos = self.closest_board_position()
        self.setPos(closest_pos[0], closest_pos[1])
        super().mouseReleaseEvent(event)
        
        
    def closest_board_position(self):
        min_distance = float('inf')
        closest_point = None
        current_x = self.scenePos().x()
        current_y = self.scenePos().y()

        
        for pos in self.board_positions:
            dx = pos[0] - current_x
            dy = pos[1] - current_y
            distance = (dx ** 2 + dy ** 2) ** 0.5
            if distance < min_distance:
                min_distance = distance
                closest_point = pos
        return closest_point

board_positions = []
square_size = 80
for row in range(8):
    for col in range(8):
        x = col * square_size
        y = row * square_size
        board_positions.append((x, y))
        rect_item = QGraphicsRectItem(x, y, square_size, square_size)
        color = QColor("white") if (row + col) % 2 == 0 else QColor("darkGray")
        rect_item.setBrush(QBrush(color))
        scene.addItem(rect_item)

Wking = fig_item("Project\Wking.png", position=(320, 560), width=80, height=80,board_positions= board_positions)
Bking = fig_item("Project\Bking.png", position=(320, 0), width=80, height=80,board_positions= board_positions)


Wquin = fig_item("Project\Wquin.png", position=(240, 560), width=80, height=80,board_positions= board_positions)
Bquin = fig_item("Project\Bquin.png", position=(240, 0), width=80, height=80,board_positions= board_positions)

W1lad = fig_item("Project\Wlad.png", position=(0, 560), width=70, height=70,board_positions= board_positions)
W2lad = fig_item("Project\Wlad.png", position=(560, 560), width=70, height=70,board_positions= board_positions)
B1lad = fig_item("Project\Blad.png", position=(0, 0), width=70, height=70,board_positions= board_positions)
B2lad = fig_item("Project\Blad.png", position=(560, 0), width=70, height=70,board_positions= board_positions)


W1knight = fig_item("Project\Wknight.png", position=(80, 560), width=70, height=70,board_positions= board_positions)
W2knight = fig_item("Project\Wknight.png", position=(480, 560), width=70, height=70,board_positions= board_positions)
B1knight = fig_item("Project\Bknight.png", position=(80, 0), width=70, height=70,board_positions= board_positions)
B2knight = fig_item("Project\Bknight.png", position=(480, 0), width=70, height=70,board_positions= board_positions)

W1bishop = fig_item("Project\Wbishop.png", position=(160, 560), width=70, height=70,board_positions= board_positions)
W2bishop = fig_item("Project\Wbishop.png", position=(400, 560), width=70, height=70,board_positions= board_positions)
B1bishop = fig_item("Project\Bbishop.png", position=(160, 0), width=70, height=70,board_positions= board_positions)
B2bishop = fig_item("Project\Bbishop.png", position=(400, 0), width=70, height=70,board_positions= board_positions)

W1peshka = fig_item("Project\Wpeshka.png", position=(0, 480), width=70, height=70,board_positions= board_positions)
W2peshka = fig_item("Project\Wpeshka.png", position=(80, 480), width=70, height=70,board_positions= board_positions)
W3peshka = fig_item("Project\Wpeshka.png", position=(160, 480), width=70, height=70,board_positions= board_positions)
W4peshka = fig_item("Project\Wpeshka.png", position=(240, 480), width=70, height=70,board_positions= board_positions)
W5peshka = fig_item("Project\Wpeshka.png", position=(320, 480), width=70, height=70,board_positions= board_positions)
W6peshka = fig_item("Project\Wpeshka.png", position=(400, 480), width=70, height=70,board_positions= board_positions)
W7peshka = fig_item("Project\Wpeshka.png", position=(480, 480), width=70, height=70,board_positions= board_positions)
W8peshka = fig_item("Project\Wpeshka.png", position=(560, 480), width=70, height=70,board_positions= board_positions)

B1peshka = fig_item("Project\Bpeshka.png", position=(0, 80), width=70, height=70,board_positions= board_positions)
B2peshka = fig_item("Project\Bpeshka.png", position=(80, 80), width=70, height=70,board_positions= board_positions)
B3peshka = fig_item("Project\Bpeshka.png", position=(160, 80), width=70, height=70,board_positions= board_positions)
B4peshka = fig_item("Project\Bpeshka.png", position=(240, 80), width=70, height=70,board_positions= board_positions)
B5peshka = fig_item("Project\Bpeshka.png", position=(320, 80), width=70, height=70,board_positions= board_positions)
B6peshka = fig_item("Project\Bpeshka.png", position=(400, 80), width=70, height=70,board_positions= board_positions)
B7peshka = fig_item("Project\Bpeshka.png", position=(480, 80), width=70, height=70,board_positions= board_positions)
B8peshka = fig_item("Project\Bpeshka.png", position=(560, 80), width=70, height=70,board_positions= board_positions)

scene.addItem(Bking)
scene.addItem(Wking)

scene.addItem(Wquin)
scene.addItem(Bquin)

scene.addItem(W1lad)
scene.addItem(W2lad)
scene.addItem(B1lad)
scene.addItem(B2lad)

scene.addItem(B1knight)
scene.addItem(B2knight)
scene.addItem(W1knight)
scene.addItem(W2knight)

scene.addItem(W1bishop)
scene.addItem(W2bishop)
scene.addItem(B1bishop)
scene.addItem(B2bishop)

scene.addItem(W1peshka)
scene.addItem(W2peshka)
scene.addItem(W3peshka)
scene.addItem(W4peshka)
scene.addItem(W5peshka)
scene.addItem(W6peshka)
scene.addItem(W7peshka)
scene.addItem(W8peshka)

scene.addItem(B1peshka)
scene.addItem(B2peshka)
scene.addItem(B3peshka)
scene.addItem(B4peshka)
scene.addItem(B5peshka)
scene.addItem(B6peshka)
scene.addItem(B7peshka)
scene.addItem(B8peshka)

scene.setBackgroundBrush(QColor("gray"))

view = QGraphicsView(scene)
layout.addWidget(view)

if __name__ == "__main__":
    if sys.platform == "win32":
        ctypes.windll.shell32.SetCurrentProcessExplicitAppUserModelID(
            "mycompany.myproduct.texteditor"
        )

app.setWindowIcon(QIcon("Project\chess_queen_icon_198474.ico"))
window = Main_window(scene)
window.show()

sys.exit(app.exec())